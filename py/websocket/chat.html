<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chat {
            width: 80%;
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
        }

        .message {
            margin: 5px 0;
            position: relative;
        }

        .message.self {
            text-align: right;
        }

        .message.other {
            text-align: left;
        }

        #messageInput {
            width: 70%;
            padding: 10px;
        }

        #sendButton {
            padding: 10px 20px;
        }
    </style>
</head>
<body>
<h1>WebSocket Chat Room</h1>
<input type="text" id="usernameInput" placeholder="Enter username...">
<button id="setUsernameButton">Set Username</button>
<div id="chat"></div>
<input type="text" id="messageInput" placeholder="Enter message...">
<button id="sendButton">Send</button>

<script>
    let username = '';
    let userId = '';

    // Function to generate a UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Create WebSocket connection
    const socket = new WebSocket('ws://localhost:6789');

    // Set username
    document.getElementById('setUsernameButton').onclick = function () {
        const input = document.getElementById('usernameInput');
        username = input.value;
        if (username) {
            userId = generateUUID();  // Generate a UUID for the user
            input.disabled = true;
            this.disabled = true;
        }
    };

    // Handle incoming messages
    socket.onmessage = function (event) {
        const chat = document.getElementById('chat');
        const data = JSON.parse(event.data);

        if (data.type === 'message') {
            const message = document.createElement('p');
            message.textContent = `${data.username}: ${data.message}`;
            message.className = 'message ' + (data.userId === userId ? 'self' : 'other');
            message.dataset.id = data.id;
            message.dataset.userId = data.userId;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;  // Auto-scroll to the latest message

            // Add context menu event listener
            message.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                if (message.dataset.userId !== userId) return; // Only allow revoking own messages

                const menu = document.createElement('div');
                menu.style.position = 'absolute';
                menu.style.top = `${e.clientY}px`;
                menu.style.left = `${e.clientX}px`;
                menu.style.backgroundColor = '#fff';
                menu.style.border = '1px solid #ccc';
                menu.style.padding = '5px';
                menu.innerHTML = '<div id="revoke">Revoke</div>';
                document.body.appendChild(menu);

                // Revoke functionality
                document.getElementById('revoke').onclick = function () {
                    const messageId = message.dataset.id;
                    socket.send(JSON.stringify({type: 'revoke', id: messageId, userId: userId}));
                    document.body.removeChild(menu);
                };

                // Remove menu when clicking elsewhere
                document.addEventListener('click', function () {
                    if (menu) {
                        document.body.removeChild(menu);
                    }
                }, {once: true});
            });
        } else if (data.type === 'revoke') {
            const message = document.querySelector(`.message[data-id="${data.id}"]`);
            if (message) {
                chat.removeChild(message);
            }
        }
    };

    // Send message
    document.getElementById('sendButton').onclick = function () {
        const input = document.getElementById('messageInput');
        const message = input.value;
        if (message && username) {
            const data = JSON.stringify({
                type: 'message',
                id: generateUUID(),  // Generate a UUID for the message
                username: username,
                userId: userId,
                message: message
            });
            socket.send(data);
            input.value = '';  // Clear input after sending
        }
    };
</script>
</body>
</html>
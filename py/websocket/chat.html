<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Room</title>
    <style>
    body {
        font-family: Arial, sans-serif;
    }

    #chat {
        width: 80%;
        height: 400px;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: scroll;
        display: flex;
        flex-direction: column;
    }

    .message {
        margin: 5px 0;
        padding: 10px;
        border-radius: 10px;
        max-width: 60%;
        display: inline-block;
    }

    .message.self {
        background-color: #d4edda; /* Green background for own messages */
        align-self: flex-end;
        text-align: right;
    }

    .message.other {
        background-color: #cce5ff; /* Blue background for others' messages */
        align-self: flex-start;
        text-align: left;
    }

    #messageInput {
        width: 70%;
        padding: 10px;
    }

    #sendButton {
        padding: 10px 20px;
    }
</style>
</head>
<body>
<h1>WebSocket Chat Room</h1>
<input type="text" id="usernameInput" placeholder="Enter username...">
<button id="setUsernameButton">Set Username</button>
<div id="chat"></div>
<input type="text" id="messageInput" placeholder="Enter message...">
<button id="sendButton">Send</button>

<script>
    let username = '';
    let userId = '';

    // Function to generate a UUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Create WebSocket connection
    const socket = new WebSocket('ws://localhost:6789');

    // Set username
    function setUsername() {
        const input = document.getElementById('usernameInput');
        username = input.value;
        if (username) {
            userId = generateUUID();  // Generate a UUID for the user
            input.disabled = true;
            document.getElementById('setUsernameButton').disabled = true;
        }
    }

    document.getElementById('setUsernameButton').onclick = setUsername;

    // Focus on the username input field when the page loads
    window.onload = function() {
        document.getElementById('usernameInput').focus();
    };

    // Handle Enter key to set username
    document.getElementById('usernameInput').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            setUsername();
        }
    });

    // Handle incoming messages
    socket.onmessage = function (event) {
        const chat = document.getElementById('chat');
        const data = JSON.parse(event.data);

        if (data.type === 'message') {
            const message = document.createElement('div');
            message.textContent = `${data.username}: ${data.message}`;
            message.className = 'message ' + (data.userId === userId ? 'self' : 'other');
            message.dataset.id = data.id;
            message.dataset.userId = data.userId;
            message.dataset.timestamp = data.timestamp;
            chat.appendChild(message);
            chat.scrollTop = chat.scrollHeight;  // Auto-scroll to the latest message

            // Add context menu event listener
            message.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                if (message.dataset.userId !== userId) return; // Only allow revoking own messages

                const messageTimestamp = new Date(parseInt(message.dataset.timestamp));
                const currentTime = new Date();
                const timeDifference = (currentTime - messageTimestamp) / 1000; // Time difference in seconds

                if (timeDifference > 60) return; // Do not show menu if message is older than 1 minute

                const menu = document.createElement('div');
                menu.style.position = 'absolute';
                menu.style.top = `${e.clientY}px`;
                menu.style.left = `${e.clientX}px`;
                menu.style.backgroundColor = '#fff';
                menu.style.border = '1px solid #ccc';
                menu.style.padding = '5px';
                menu.innerHTML = '<div id="revoke">Revoke</div>';
                document.body.appendChild(menu);

                // Revoke functionality
                document.getElementById('revoke').onclick = function () {
                    const messageId = message.dataset.id;
                    socket.send(JSON.stringify({type: 'revoke', id: messageId, userId: userId}));
                    document.body.removeChild(menu);
                };

                // Remove menu when clicking elsewhere
                document.addEventListener('click', function () {
                    if (menu) {
                        document.body.removeChild(menu);
                    }
                }, {once: true});
            });
        } else if (data.type === 'revoke') {
            const message = document.querySelector(`.message[data-id="${data.id}"]`);
            if (message) {
                chat.removeChild(message);
            }
        }
    };

    // Send message
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value;
        if (message && username) {
            const data = JSON.stringify({
                type: 'message',
                id: generateUUID(),  // Generate a UUID for the message
                username: username,
                userId: userId,
                message: message,
                timestamp: Date.now()  // Add timestamp to the message
            });
            socket.send(data);
            input.value = '';  // Clear input after sending
        }
    }

    document.getElementById('sendButton').onclick = sendMessage;

    // Handle Ctrl+Enter to send message
    document.getElementById('messageInput').addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>